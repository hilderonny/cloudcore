{"entities":{"tabs":[{"id":"4b380de5-7264-4a52-81aa-ee83e4160176","url":"/setup/packages","label":"Pakete","appid":"9a80bfa4-72a9-43ba-b71c-521520afbb6c","userid":"6f6b93ae-94e5-45b0-904f-83a8b37e1627","ispublic":true}],"routers":[{"id":"a3a9d900-6fa8-4818-8838-4a4f41a2caab","code":"// select table_name, column_name from information_schema.columns where table_schema='public' and not column_name = 'id';\nvar router = require('express').Router();\n\nrouter.get('/allfields', async (req, res) => {\n    var result = await req.db.query(\"SELECT table_name, column_name FROM information_schema.columns WHERE table_schema='public' AND column_name NOT IN ('id');\");\n    var tablemap = {};\n    for (var row of result.rows) {\n        if (!tablemap[row.table_name]) tablemap[row.table_name] = [];\n        tablemap[row.table_name].push(row.column_name);\n    }\n    res.json(tablemap);\n});\n\nrouter.get('/packagefields/:packageid', async (req, res) => {\n    var result = await req.db.query(\"select * from packagefields where packageid = '\" + req.params.packageid + \"';\");\n    res.json(result.error || result.rows);\n});\n\nrouter.get('/packageentities/:packageid', async (req, res) => {\n    var result = await req.db.query(\"select * from packageentities where packageid = '\" + req.params.packageid + \"';\");\n    res.json(result.error || result.rows);\n});\n\nrouter.delete('/:packageid', async (req, res) => {\n    await req.db.query(\"DELETE FROM packagefields WHERE packageid = '\" + req.params.packageid + \"';\");\n    await req.db.query(\"DELETE FROM packageentities WHERE packageid = '\" + req.params.packageid + \"';\");\n    await req.db.query(\"DELETE FROM packages WHERE id = '\" + req.params.packageid + \"';\");\n    res.send();\n});\n\nrouter.get('/download/:packageid', async (req, res) => {\n    var packageid = req.params.packageid;\n    var json = { entities: {} };\n    var package = (await req.db.query(\"select id, name from packages where id='\" + packageid + \"';\")).rows[0];\n    json.id = package.id;\n    json.name = package.name;\n    var packagefields = (await req.db.query(\"select tablename, fieldname from packagefields where packageid = '\" + req.params.packageid + \"';\")).rows.reduce((map, field) => {\n        if (Object.keys(map).indexOf(field.tablename) < 0) map[field.tablename] = [];\n        map[field.tablename].push(field.fieldname);\n        return map;\n    }, {});\n    var columndefs = (await req.db.query(\"select column_name, table_name, data_type from information_schema.columns where table_schema='public';\")).rows.reduce((map, column) => {\n        if (packagefields[column.table_name] && packagefields[column.table_name].indexOf(column.column_name) >= 0) {\n            if (Object.keys(map).indexOf(column.table_name) < 0) map[column.table_name] = {};\n            map[column.table_name][column.column_name] = column.data_type;\n        }\n        return map;\n    }, {});\n    json.fields = columndefs;\n    var packageentities = (await req.db.query(\"select tablename, entityid from packageentities where packageid = '\" + req.params.packageid + \"';\")).rows.reduce((map, entity) => {\n        if (Object.keys(map).indexOf(entity.tablename) < 0) map[entity.tablename] = [];\n        map[entity.tablename].push(entity.entityid);\n        return map;\n    }, {});\n    for (var [tablename, entityids] of Object.entries(packageentities)) {\n        var query = \"select * from \\\"\" + tablename + \"\\\" where id in (\" + entityids.map(id => \"'\" + id + \"'\").join(',') + \");\";\n        json.entities[tablename] = (await req.db.query(query)).rows;\n    }\n    res.setHeader('Content-Type', 'application/json');\n    res.setHeader('Content-disposition','attachment; filename=' + package.name + '.json');\n    res.json(json);\n});\n\nmodule.exports = router;","url":"/api-packages","userid":"6f6b93ae-94e5-45b0-904f-83a8b37e1627","ispublic":true}],"views":[{"id":"d467c535-8c83-4b8a-a638-cdaf9375bedc","content":"<!DOCTYPE html>\n<html>\n    <head>\n        <link rel=\"stylesheet\" href=\"/assets/slds.css\">\n        <script src=\"/ccc/cc-globalnav\"></script>\n        <script>\n\n            var package;\n\n            function htmlencode(str) {\n                return ('' + str).replace(/</g, '&lt;').replace(/>/g, '&gt;')\n            }\n\n            async function selecttable() {\n                var selectedtable = document.getElementById('tables').value;\n                var content = await (await fetch('/api-data/list/' + selectedtable)).json();\n                var tbody = document.querySelector('#availableentities tbody');\n                tbody.innerHTML = '';\n                var columns = {};\n                var maxlength = 1000;\n                for (var entity of content) {\n                    var tr = document.createElement('tr');\n                    tbody.appendChild(tr);\n                    for (var key of Object.keys(entity)) {\n                        columns[key] = true;\n                    }\n                    tr.innerHTML = Object.values(entity).map(v => {\n                        var text = htmlencode(v && v.length > maxlength ? v.substring(0, maxlength) : v);\n                        return '<td title=\"' + text.replace(/\\\"/g, '&quot;') + '\">' + text + '</td>';\n                    }).join('');\n                    tr.innerHTML += '<td><a href=\"#\" onclick=\"addentity(\\'' + entity.id + '\\');\">Hinzufügen</a></td>';\n                }\n                var thead = document.querySelector('#availableentities thead');\n                thead.innerHTML = '<tr>' + Object.keys(columns).map(c => '<th>' + c + '</th>').join('') + '<th></th><th></th></tr>';\n            }\n\n            async function addentity(entityid) {\n                var selectedtable = document.getElementById('tables').value;\n                await fetch('/api-data/packageentities', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tablename: selectedtable, entityid: entityid, packageid: package.id }) });\n                load();\n            }\n\n            async function deletepackageentity(id) {\n                await fetch('/api-data/packageentities/' + id, { method: 'DELETE' });\n                load();\n            }\n\n            async function load() {\n                var packageid = location.search.substring(1);\n                package = (await (await fetch('/api-data/packages/' + packageid)).json())[0];\n                document.getElementById('packagename').innerHTML = package.name;\n                var tables = await (await fetch('/api-schema/tables')).json();\n                tables.sort((a, b) => a.table_name > b.table_name ? 1 : -1);\n                var tablesselect = document.getElementById('tables');\n                tablesselect.innerHTML = '';\n                for (table of tables) {\n                    tablesselect.innerHTML += '<option value=\"' + table.table_name + '\">' + table.table_name + '</option>';\n                }\n                tablesselect.selectedIndex = 0;\n                selecttable();\n                var packageentities = await (await fetch('/api-packages/packageentities/' + packageid)).json();\n                packageentities.sort((a, b) => a.tablename > b.tablename ? 1 : -1);\n                var tbody = document.querySelector('#packageentities tbody');\n                tbody.innerHTML = '';\n                for (var packageentity of packageentities) {\n                    var tr = document.createElement('tr');\n                    tr.innerHTML = '<td>' + packageentity.tablename + '</td><td><a href=\"/setup/tables/content/edit?' + packageentity.tablename + '/' + packageentity.entityid + '\">' + packageentity.entityid + '</a></td><td><a href=\"#\" onclick=\"deletepackageentity(\\'' + packageentity.id + '\\');\">Entfernen</a></td>';\n                    tbody.appendChild(tr);\n                }\n            }\n\n            window.addEventListener('load', load);\n\n        </script>\n    </head>\n    <body>\n        <cc-globalnav selectedurl=\"/setup/packages\"></cc-globalnav>\n        <header>\n            <img src=\"https://fonts.gstatic.com/s/i/materialicons/local_shipping/v4/24px.svg\"/>\n            <subtitle>Setup &gt; <a href=\"/setup/packages\">Pakete</a></subtitle>\n            <page-title><span id=\"packagename\"></span> - Daten</page-title>\n            <button>\n                <select id=\"tables\" onchange=\"selecttable();\"></select>\n            </button>\n        </header>\n        <content>\n            <table id=\"availableentities\">\n                <thead></thead>\n                <tbody></tbody>\n            </table>\n        </content>\n        <content>\n            <table id=\"packageentities\">\n                <thead><tr><th>Tabelle</th><th>Datensatz</th><th></th></tr></thead>\n                <tbody></tbody>\n            </table>\n        </content>\n    </body>\n</html>","contenttype":"text/html","url":"/setup/packages/entities","userid":"6f6b93ae-94e5-45b0-904f-83a8b37e1627","ispublic":true},{"id":"2ae98d59-3e80-4be4-aa65-822f11656514","content":"<!DOCTYPE html>\n<html>\n    <head>\n        <link rel=\"stylesheet\" href=\"/assets/slds.css\">\n        <script src=\"/ccc/cc-globalnav\"></script>\n        <script>\n\n            async function createpackage() {\n                var packagename = window.prompt('Name des neuen Paketes');\n                if(!packagename) return;\n                await fetch('/api-data/packages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: packagename }) });\n                loadpackages();\n            }\n\n            async function deletepackage(id) {\n                if (!confirm('Soll das Paket mit der Id \"' + id + '\" wirklich gelöscht werden?')) return;\n                await fetch('/api-packages/' + id, { method: 'DELETE' });\n                loadpackages();\n            }\n\n            async function loadpackages() {\n                var packages = await (await fetch('/api-data/list/packages')).json();\n                packages.sort((a, b) => a.name > b.name ? 1 : -1);\n                var tbody = document.querySelector('tbody');\n                tbody.innerHTML = '';\n                for (var package of packages) {\n                    var tr = document.createElement('tr');\n                    tr.innerHTML = '<td><a href=\"/setup/tables/content/edit?packages/' + package.id + '\">' + package.name + '</a></td><td>' + package.description + '</td><td><a href=\"/setup/packages/entities?' + package.id + '\">Daten</a></td><td><a href=\"/setup/packages/fields?' + package.id + '\">Felder</a></td><td><a href=\"#\" onclick=\"deletepackage(\\'' + package.id + '\\');\">Löschen</a></td><td><a href=\"/api-packages/download/' + package.id + '\" target=\"_blank\">Download</a></td>';\n                    tbody.appendChild(tr);\n                }\n            }\n\n            async function upload(files) {\n                for (var file of files) {\n                    var content = await file.text();\n                    var result = await fetch('/api/packageupload/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body:content });\n                    console.log(await result.text());\n                }\n                loadpackages();\n            }\n\n            window.addEventListener('load', loadpackages);\n\n        </script>\n    </head>\n    <body>\n        <cc-globalnav selectedurl=\"/setup/packages\"></cc-globalnav>\n        <header>\n            <img src=\"https://fonts.gstatic.com/s/i/materialicons/local_shipping/v4/24px.svg\"/>\n            <subtitle>Setup</subtitle>\n            <page-title>Pakete</page-title>\n            <button onclick=\"createpackage();\">Neues Paket</button>\n            <button>\n                <label for=\"upload\">\n                    <span>Upload</span>\n                    <input type=\"file\" name=\"upload\" id=\"upload\" accept=\"application/json\" onchange=\"upload(this.files);\" />\n                </label>\n            </button>\n        </header>\n        <content>\n            <table>\n                <thead><tr><th>Name</th><th>Beschreibung</th><th></th><th></th><th></th><th></th></tr></thead>\n                <tbody></tbody>\n            </table>\n        </content>\n    </body>\n</html>","contenttype":"text/html","url":"/setup/packages","userid":"6f6b93ae-94e5-45b0-904f-83a8b37e1627","ispublic":true},{"id":"81731013-bfd2-442e-85b2-5cf182da71cb","content":"<!DOCTYPE html>\n<html>\n    <head>\n        <link rel=\"stylesheet\" href=\"/assets/slds.css\">\n        <script src=\"/ccc/cc-globalnav\"></script>\n        <script>\n\n            var package, allfields;\n\n            function selecttable() {\n                var selectedtable = document.getElementById('tables').value;\n                var fieldsselect = document.getElementById('fields');\n                fieldsselect.innerHTML = '';\n                for (var field of allfields[selectedtable]) {\n                    fieldsselect.innerHTML += '<option value=\"' + field + '\">' + field + '</option>';\n                }\n            }\n\n            async function addfield() {\n                var selectedtable = document.getElementById('tables').value;\n                var selectedfield = document.getElementById('fields').value;\n                await fetch('/api-data/packagefields', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tablename: selectedtable, fieldname: selectedfield, packageid: package.id }) });\n                load();\n            }\n\n            async function deletepackagefield(id) {\n                await fetch('/api-data/packagefields/' + id, { method: 'DELETE' });\n                load();\n            }\n\n            async function load() {\n                var packageid = location.search.substring(1);\n                package = (await (await fetch('/api-data/packages/' + packageid)).json())[0];\n                document.getElementById('packagename').innerHTML = package.name;\n                allfields = await (await fetch('/api-packages/allfields')).json();\n                var tablesselect = document.getElementById('tables');\n                tablesselect.innerHTML = '';\n                for (table of Object.keys(allfields)) {\n                    tablesselect.innerHTML += '<option value=\"' + table + '\">' + table + '</option>';\n                }\n                tablesselect.selectedIndex = 0;\n                selecttable();\n                var packagefields = await (await fetch('/api-packages/packagefields/' + packageid)).json();\n                packagefields.sort((a, b) => a.tablename === b.tablename ? (a.fieldname > b.fieldname ? 1 : -1) : (a.tablename > b.tablename ? 1 : -1));\n                var tbody = document.querySelector('tbody');\n                tbody.innerHTML = '';\n                for (var packagefield of packagefields) {\n                    var tr = document.createElement('tr');\n                    tr.innerHTML = '<td>' + packagefield.tablename + '</td><td>' + packagefield.fieldname + '</td><td><a href=\"#\" onclick=\"deletepackagefield(\\'' + packagefield.id + '\\');\">Löschen</a></td>';\n                    tbody.appendChild(tr);\n                }\n\n            }\n\n            window.addEventListener('load', load);\n\n        </script>\n    </head>\n    <body>\n        <cc-globalnav selectedurl=\"/setup/packages\"></cc-globalnav>\n        <header>\n            <img src=\"https://fonts.gstatic.com/s/i/materialicons/local_shipping/v4/24px.svg\"/>\n            <subtitle>Setup &gt; <a href=\"/setup/packages\">Pakete</a></subtitle>\n            <page-title><span id=\"packagename\"></span> - Felder</page-title>\n            <button>\n                <select id=\"tables\" onchange=\"selecttable();\"></select>\n            </button>\n            <button>\n                <select id=\"fields\"></select>\n            </button>\n            <button onclick=\"addfield();\">Hinzufügen</button>\n        </header>\n        <content>\n            <table>\n                <thead><tr><th>Tabelle</th><th>Feld</th><th></th></tr></thead>\n                <tbody></tbody>\n            </table>\n        </content>\n    </body>\n</html>","contenttype":"text/html","url":"/setup/packages/fields","userid":"6f6b93ae-94e5-45b0-904f-83a8b37e1627","ispublic":true}]},"id":"4e596017-1984-43e7-bb99-1c005f2ef32a","name":"packaging","fields":{}}