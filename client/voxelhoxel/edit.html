<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script src="https://arrange.avorium.de/arrange-client.min.js"></script>
    <script src="three.js"></script>
    <script src="three.orbitcontrols.js"></script>
    <script src="utils.js"></script>
    <script src="editor.js"></script>
    <script>
      
      // Palette by Arne http://androidarts.com/palette/Famicube.htm
      const palette64 = [ '#000000', '#00177D', '#024ACA', '#0084FF', '#5BA8FF', '#98DCFF', '#9BA0EF', '#6264DC', '#3D34A5', '#211640', '#5A1991', '#6A31CA', '#A675FE', '#E2C9FF', '#FEC9ED', '#D59CFC', '#CC69E4', '#A328B3', '#871646', '#CF3C71', '#FF82CE', '#FFE9C5', '#F5B784', '#E18289', '#DA655E', '#823C3D', '#4F1507', '#E03C28', '#E2D7B5', '#C59782', '#AE6C37', '#5C3C0D', '#231712', '#AD4E1A', '#F68F37', '#FFE737', '#FFBB31', '#CC8F15', '#939717', '#B6C121', '#EEFFA9', '#BEEB71', '#8CD612', '#6AB417', '#376D03', '#172808', '#004E00', '#139D08', '#58D332', '#20B562', '#00604B', '#005280', '#0A98AC', '#25E2CD', '#BDFFCA', '#71A6A1', '#415D66', '#0D2030', '#151515', '#343434', '#7B7B7B', '#A8A8A8', '#D7D7D7', '#FFFFFF' ];
      const dbName = 'voxelhoxel', collectionName = 'models';
      var _id, model, arrangeClient;
      
      window.addEventListener('load', async function() {

        arrangeClient = await ArrangeClient().connect('wss://arrange.avorium.de:42001');

        const renderer = Editor.init();
        document.getElementById("rendering").appendChild(renderer);
        
        _id = getRequestParameters()._id;
        if (_id) {
          model = await arrangeClient.read(dbName, collectionName, _id);
        } else {
          model = {
            colorpalette: [ '#000000', '#000080', '#008000', '#008080', '#800000', '#800080', '#808000', '#C0C0C0', '#808080', '#0000FF', '#00FF00', '#00FFFF', '#FF0000', '#FF00FF', '#FFFF00', '#FFFFFF' ],
            pos: { x: 2, y: 4, z: 5 },
            target: { x: 0, y: 0, z: 0 },
            scene: { 0: { 0: { 0: 0 } } },
            painted: {},
            complete: false,
            version: 1
          };
        };

        document.getElementById('colorpalette').addEventListener('touchmove', function(e){e.stopPropagation()}, false);
        document.getElementById('colorbar').addEventListener('touchmove', function(e){e.stopPropagation()}, false);
        
        Editor.loadModel(model);
        createColorPalette();
        createColorBar();
        
        setMode('add');
        selectColor(0);
        
        Editor.start();
        
      });
      
      function createColorBar() {
        const colorBar = document.getElementById('colorbar');
        model.colorpalette.forEach(function(color, index) {
          colorBar.innerHTML += '<label><input type="radio" name="color"' + (index === 0 ? ' checked' : '') + ' onchange="selectColor(' + index + ');" /><div style="background-color:' + color + '">' + index + '</div></label>';
        });
      }
      
      function createColorPalette() {
        const colorPalette = document.getElementById('colorpalette');
        palette64.forEach(function(color, index) {
          colorPalette.innerHTML += '<label><input type="radio" name="colorpalette"' + (index === 0 ? ' checked' : '') + ' onchange="setPaletteColor(' + index + ');" /><div style="background-color:' + color + '"></div></label>';
        });
      }
      
      async function deleteModel() {
        if (confirm('Soll das Modell wirklich gelÃ¶scht werden?')) {
          if (_id) await arrangeClient.delete(dbName, collectionName, _id);
          location.href = 'creative.html';
        }
      }
      
      async function duplicate() {
        model.thumbnail = Editor.makeScreenshot();
        model.painted = {}; // In creative mode we do not store painted voxels in the database
        model.version = model.version ? model.version + 1 : 1; // Increment version
        delete model._id;
        const result = await arrangeClient.create(dbName, collectionName, model);
        _id = result._id;
        model._id = _id;
        alert('Dupliziert');
      }
      
      async function save() {
        model.thumbnail = Editor.makeScreenshot();
        model.painted = {}; // In creative mode we do not store painted voxels in the database
        model.version = model.version ? model.version + 1 : 1; // Increment version
        if (_id) {
          await arrangeClient.update(dbName, collectionName, _id, model);
        } else {
          const result = await arrangeClient.create(dbName, collectionName, model);
          _id = result._id;
          model._id = _id;
        }
        alert('Gespeichert');
      }
      
      function selectColor(colorIndex) {
        Editor.selectColor(colorIndex);
        event.preventDefault();
      }
      
      function setMode(mode) {
        Editor.setMode(mode);
        document.getElementById('colorbar').style.display = (['add', 'paint', 'play'].indexOf(mode) >= 0) ? 'flex': 'none';
        Editor.forceResize();
      }
      
      function setPaletteColor(paletteIndex) {
        const color = palette64[paletteIndex];
        document.getElementsByName('color').forEach(function(input) { 
          if (!input.checked) return;
          input.nextElementSibling.style.backgroundColor = color;
        });
        Editor.setCurrentColor(color);
        event.preventDefault();
      }
      
      function toggleColorPalette() {
        document.getElementById('colorpalette').classList.toggle('visible');
        Editor.forceResize();
      }
      
    </script>
    <link rel="stylesheet" href="editor.css"/>
  </head>
  <body>
    
    <div id="rendering"></div>
    
    <div id="toolbar">
      <!-- https://stackoverflow.com/a/17541916 -->
      <img onclick="save();" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAQbSURBVGhD7ZldTxNBFIb5EXqr/iHvvPIHeCGiCZqoN2r0Qo2o6IUFlRahVgUk0YraFpCWjxakIqlVqQUEv9AqVRQTCnqcdzpTp9stXWh3MXFP8qQzc2Znzjs9Z7ZJq2yzzbZCO7P76ta6aue+s9XOgxaz80JN02YRxvrs/D7XtrN7XAsM2hBqmtPnapzbRThrN37ybCFfzysKRT/kuNU8yDcITC3l8WRuhYbeLvN23+sMJeeJpr5mSaaJ+mYy3BeazdAk60ufCtb1XA7Sw0CCGo7dXmb9lTM1TTtESGuzuj2uQ1hQDb6YgDALPMoEoN3DePHldy6oScagENb7eolezTMfEzAQniH/gzjFZ37kC2gM8n36Im+o4Xjn+kUYFRBkJxtL/aJu0R//9CsXEIh+yAqDP/45K+yOZ5ivAS4ecOdEoC8FgLJEGBHQM82CYsH3sJNFf+T9Sl7wEIZxMMa+ITl+cX8r3XM4KRW/ytfydz3j41oB4NHwOkWUEoATjbHTDonc7tfk9gRLIwiEDykmx2Wg/TebiFJXeNvbNspTDW2tAKCKMFzYpQSMstSIvMvm9qPpTDa3RYAQIosWKZYU46sJQKqhrScAQITjSMfyub3N83W7GjeJMItbKQFPPorcZqf8IvU3eCBvo17mSygFLdEK6Lz5mM9fTQB4GJjgc/CeEGEWt5IpJNJj7GN+0eI65cIYz1gNqD4JnlcFuFuGDQkIjr7nc+qqXSdEmMXNSBEjhdTAUNDyNkJKqD4VbRF72scNCQCYw76BkyLM4lZKgPaFNMFqQN5GQ2/yhWm54xnJBsKo3++m++Np6wUklKJFkcrbCMWLN68acAHM7wtO043bsVzwlglobw3zRZ4m0rmAIqJocW2+1ClaLWqqSbyPP/F1266FC/ZUKVtAIDhFF9jXzheqMPW1buoOTRfsqcLnliMAYBOcFH54VQqsVyp4UBEBG4ktAKAOUMy3XIOmgLWLpVPZArpRxLWt2YVMBHvoieD+cgTIa3QuEaNMesoUsDb20LtSyxYgX2R6G1cS7KH3UrMF6AmY97gpdclhCMzFM4vjQ5RyNBSMSywVsPh0kBb6fIbAXDyz9O45fQ/6C8YllgowA0sFrCWFVLRpo2KpgLWkkIo2bVQsFWAGtgBbQJlYIiAeilDzibbcpv4WH0f24YsFI7z9eTJODYc9/BP9Us+aLmApPUkDnQHeXnw7xvGcbufIPny97i7eTob7eR+f6A90+HSf/TkX42vDZ6qAb8l+inq95Dx6ndIvezldjR0c2YcvetfL27PDfnIcbKHZET/vr/Ys1jZdgNzYLGwBpf5i0tu0kugJQCwYZ7HVijCLG/6hZJM37k++4izU7722RYS5umEi1LJ0OvVPwGIxHLxttv1XVlX1B05YqkjqZfZqAAAAAElFTkSuQmCC"/>
      <img onclick="duplicate();" src="duplicate.png"/>
      <label>
        <input type="radio" name="mode" onchange="setMode('play');"  />
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAALRSURBVGhD7ZjbahNRFIZzL6K+kaAg6Et44Y1XvoCHV/CEUbzQC5tENOcoddoqzQFqKsQe4qFpE42HIrQieKFOhO38O2uS3WElKxQlW9g/fLCZWf9a/7Qzs4fEnJycnJycovI2e6e8Lf/jXLunbABZgkwnKZ4sr+1/4BpNF79L8WTxDaYPxZPFmW2A4snizDZA8WRxZhugeLI4sw1QPFmc2QYonizOPAlPNn+q9IuuujP7XN3MzKlryaIGaxzDOdRw3kmgeLI48zi8rV/qfnVDXU+V1OV7mbGgJlV9qz1cr3FQPFmceRTFtV0Vz3iDgLfzC+ppo6U6X76q7z98DdY4hnNhHTylwMv1HAXFk8WZOR4stdWVmZwOdCu4TVY72wrKfdpRRxdX1IFcVYN1/vOOPoca1MIDL3pwvTkonizOHCVRfjX4a2YqDeX3fuuAF5odFXu4yHJ+vaNrUJstNwZ+9OJmRKF4sjizSbLyZjD82cuWDgWVtnfZ4CaoCQVv2Ac9uVkmFE8WZw5JL3f7Q2eyqrLWpih9HSuvDMPeSKrY2XN9sKbjqDGFHuiFnun6e3ZmCMWTxZlBqfkteC0W9LCFxgZFGOpIoTa8AAQ/faYP1nT8UL5G1UPhAUfPq4mCnsHNBhRPFmcGf+MCDk/zAgA2IwzjbqHj5dXhBcSNWwhrOo4aU3tuoeV/fAuFpKr8Q/xogof48YiHGD25WSYUTxZnjpKsvB4MN1+jl5rv2ODgYnAOir5G0YubEYXiyeLMHHojS+R1CHMjw6sSb5uDwSYGsMZ/B9qzkQXeqW1kIcX1/X9KwMv1HAXFk8WZx6E/5mqtiT/mUGvNx5wJQmWCje7ubF3Fs/PG5/R88Dld1+f2EzyE4snizDZA8WRxZhugeLI4sw1QPFmc2QYonizObAMUTxZntgGKJ+u//3EXP2XbdRF+12v3TlA8JycnJycnUiz2B7fpZ0WotjIxAAAAAElFTkSuQmCC"/>
      </label>
      <label>
        <input type="radio" name="mode" onchange="setMode('paint');"  />
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAOGSURBVGhD7ZZbSBRRGMfHsIslabWSmbk7s+BDmEEGVhgiZUUE9uDO6Ba9RlFR0UPRRXvpJapHTYtuFkF3EekhhSTUMnvpoQi0sMtTF61V6ML5+s54Zp0dz7juujPOwvzhzw5n5sz5/c98M/sJrly5chWTyKP1Irme8408WBNkQ8kjFf6qZxjqBSCNc0hShdDDa06aEDz4pAkBd0skM3jNjg1BOvZnkRtLf/KgjXZcCNJZs5A8rujjwZrZMSFU+J7aXmgu5YKqbkgFuJgybnzaQ4ThX9YCtAXHAcKluQCtWwFeHB89Np5HT1sIaD7sCcNrbtkEcC0L4KYXjzcCPD86Ot6xmwuv2fYQgxsypIFyz1CoTh6Dn8j3i7ngetsW4kd5hjiwauZwX4EA/StnQNQQPTWm5WO05SHI9pxFA6tnhSi8ZjVE/QQhuo9wYc1sWQgI5i0gitgb2rIY+lekhANED3EKn8A8LqyZEx4CBCGFyFI3KBJQxxyibSfAlUyAy+kAt/Ae94oAGmdz4TXTLpYtnxjh7n/SAsQVwuimZVxwatqO0J6KLZ0YEUU6ow8wpRD0xW7gPwG1l2opkdiyiRM+gXxjgLhDPNtnAp8dsgReE74HbxISovMQthYzIuFv538nLWVetpQ1wgDneAGoYw7RvgPgTiHAw3VA2ne9pW0JW8Y6kYBUzYPXHE850XbEFngqCPiLeOB6xxLCVngqIot7edBGTyaEvTtfWpqK9V+Dn1LCA+Z5ohC2wavgihhEv+ZBRrMaoiAyBO1iaSvOlrBGEFiejjt+EP2BBxaL9SFoF0tbcbaMNaIvKtb6Ox5MvKYhaBc7WDbfz5axRqTKV4x1PsyDMDOpkg6QoM8LAakES20Phm/F398R18jiK9i2xOqykTJwoY/6haMZwzax6RGC6nwP3usYvR+6h1Tm2vAnpYh1PEgzI/wIBLzZbLqpaCvODq0TqcwTcaf+hOFk6Qu6G0P91UPrjecusOnTL4Q/HQaTxSf4yNPouFrXumDhaya5+7aJ1ukYnF9hw6oQtksPr14jS2fZaWdI3VENTpFOsmEsrdw0Wk4G+M9Q4c1klzhD+ASGdAFGEPIECfhkWk4R8Ir4i1T617JpzhFCP9WD8oyh3pMqsZBNcZaI7C/DEP+44PglQvjzjisbo4js24yw7eivo5a6aCnhlyiPXeLKlStXU5Eg/AdG38EFRmMrzwAAAABJRU5ErkJggg=="/>
      </label>
      <label>
        <input type="radio" name="mode" onchange="setMode('add');" checked />
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAFISURBVGhD7ZlNSsRQEIRzEF0pL15ZE9zrqO/hAbyLK1cj/hxAp7EQaWpRPWTyHOgPvlWgujozq/SQJEnyf7k+q6dTaXdTqR/z2L7W1GZOY324LI8XqBPDys+lbVn4qpb6enV+f4JaOvbmaWAPS92gls7u7X/SsA7u/krvqKXDgnqKWjospKeopcNCIj4/vfzKnkdFLR0WEjEXcKKWDguJmAs4UUuHhUTMBZyopcNCIuYCTtTSYSERcwEnaumwEPNvsUPIZpqopcNCTDZ0SdlME7V0WIjJhi4pm2milg4LiaiUiohaOiwkYi7gRC0dFhIxF3Cilg4LiZgLOFFLh4VEzAWcqKXDQiIe/QJLi1o6LKSnqKVz9B937bjAwno4je0GtXTsMmLHBRa4qqVt9zpwGD9Xmrqxn5CGH9a3eay3e5dPkiRZgWH4BpSe3oKhBqQLAAAAAElFTkSuQmCC"/>
      </label>
      <label>
        <input type="radio" name="mode" onchange="setMode('remove');"  />
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJPSURBVGhD7ZnNTtRQAIXnoWiHyIoOhkRAXbjnKWSlCxJiXMCGF8AEYuLCaEyMG4MvIiQqG/5cMB0CjOHSW09JO3PaObeDc4npSb4FzMzpd9I2k3RaTZo0aXK/04vCp3EUfOtGYRx3QjMJ0mMlx+zNth9Do166nfA1O8AkSRzWoOOWXid8wgp90IumlqClx55CVuaHYBdaeiZ5zY8mOIOWHl7kD2jpYSU+gZYeVkKZf2DiuTZ/7Q6Blh5WMsT8jPnz5bO52n7jPOLixfMU9hoDWnpYSQHIm+PfKS4jrLg5PElRR0BLDyvJ03/39lbeZcStfPY5cQS09LCSPOfLz8z19/3CAEvViCF5i68BFpcR48hboKWHlTCUEePKW6Clh5WUUTXi4uXK2PIWaOlhJVWUjTBHp8W/a8hboKWHlYyidERGTXkLtPSwEoV0xI+DYfnkTNjLiX1GAVp6WIlCesMeDVzzQPmeKANaeljJKFL5wRt2gLojoKWHlVRB5ZMzcf3zV/F/CXVGQEsPKymDyuOGTe+JPe3Lrgpo6WEljCr57D13MQJaeljJIIp8RumInS1pBLT0sJI8LvIZlSPI+/NASw8rydP/+L4oMkI+g4243Nyg780DLT2spMDDadP/9MFJPiM/QpG3QEsPKxnCjkjOhIt8hh1xuf6KvsaAlh5W4hNo6WElPoGWHlbiE2jp+Q8eLQa7vMwHNR7u2kfavMwLC9Byi/1xgZRNlG4nWIVOvSSnb/Hv5RScsQP8G5JjReHXeLb9CBpNmjRpci/Tat0AOcsXW3RXjVwAAAAASUVORK5CYII="/>
      </label>
      <img onclick="toggleColorPalette();" src="palette.png"/>
      <div class="spacer"></div>
      <img onclick="deleteModel();" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAANESURBVFhH7ZhdTxNREIa58gf4Z/wXGowajV54ozEmxhBDpLUIgkYF+oF6gRQQwQLiRyhFKpYINaKBAqIVIYAKRr5MFIKCRFLHznpmadlhd09ZKiS+yRsazsyZl7O7T0szto1cNt+r4uzbsBXstvv6RaxV4cLY4MKWMGYRsVb1P6CE2YBum68PF7aCMYuIlSy789Zi+/hPeDYD/8Q4GzOIOFrlltYM+6MzbHM6jLMxg4ijlcNT01T/YpRtTodxdjygX8TR6qyzosDbGolxzemwNxiJYQYRR6uckorD7vrQAtecDuNszCDiaJVTXLmr8Oa9ea45HcbZmEHE0SrL6d0Zf4qWuWYje9o+wqFL7XCgIARFgTEIT/N1esbZmEHE4ZUKaso6P8Nu+6Mklz4ZZ2vXsyFiSLKoCU38goOFITXYnnN/f+7Pb4Pg+2W2h7MhYkjnJVFzPTQBJ2+8VIKdqewFW+1rNSy+5no4GyKGlCpqsqv6ITCyqJwanh6dZsPAHFu/1jhTFzGkVFHTMRlTX7uCH9RTvNps7moYIoZkFjXV3V/gdHlP/DIOaNY6p36Do+4NHLn8FOr7v2nWORsihmQGNaFPKwpS8IT2XWiDcDwQV4cm3ISn169Bm0IMyQg1Fx8Oq5cwyxthaxLdNPQdrvhH2DW0acSQ8HFvjs6ym+GDkJkbVMJlOoLgH/7B1qHbJ1aUW+B4aRfsjfe0jCyxdTjLFGJI+Livh5q8hrfq6RXcf8fWJDr/7qBaj71cjWnEkPRQc6qsWx14tDgMxzzPFfv6virreD/m1kXV32MN1WPv2v3QphFD0kMN3ks0kHziWpe6XhQY1ayT8T06cS+yacSQFNSU86jpmIpBfuNg8tubo1U9Qbzv8OQSg2Ft4YMh6Jzkn2ScZQoxJDOosdJSiCEZocYqSyOGpIcaKy2NGJIeaqw0zsBPUGKseeFjX/G4d9P/gfIGe+UQQ0r1U42spRFD0kONlZZGDCldqEkJMSTui53NsBgnL2zmvh6z0hsK6LLVzkcjs+zGVjjaMwMum29OjJOXx3bHXe1sXcSNuAEbMe5ZVdKy5Lb7XGKcvPLyGnfgBvhXJt4zVhj3xL1xhhi3HZWR8QdHb2kmZmwS0gAAAABJRU5ErkJggg==" />
    </div>
    
    <div id="colorpalette"></div>
    
    <div id="colorbar"></div>
    
    <div id="toptoolbar">
      <img onclick="location.href='creative.html';" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAMCAYAAAC0qUeeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTCtCgrAAAAAWUlEQVQoU42MAQ7AIAgDfTo/ZysFBiNzNqnacrhUtfkWDvOYtfBAe7iCUORm9gw7OfMPQgmfKGER8epbCZ8sGMd7LuBdnTD8XojcHDDnLOOnOrP5KHxhwrouHQNfPTts4ocAAAAASUVORK5CYII=" />
    </div>
    
  </body>
</html>
