<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html { width: 100%; height: 100% }
      body { display: flex; flex-direction: column; width: 100%; height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
      .list { overflow: auto; flex: 1; text-align: center; background-color: #fcfcfc; }
      .list div { cursor: pointer; display: inline-block; margin: 8px; padding: 0 0 4px 0; border-radius: 8px; box-shadow: 0px 0px 3px 0px rgba(0,0,0,0.8); background-color: #eee; position: relative; }
      .list div img { border-radius: 8px; }
      .list div span.new { display: block; position:absolute; top:0; right: 0; color: #fff; background-color: #0be; padding: 4px; border-radius: 0 8px; text-transform: uppercase; font-weight: bold; font-size: 18px; }
      .list div span.complete { display: block; position:absolute; top:0; left: 0; color: #fff; background-color: #0c0; padding: 4px 12px; border-radius: 8px 0; text-transform: uppercase; font-weight: bold; font-size: 18px; }
    </style>
    <script src="https://arrange.avorium.de/arrange-client.min.js"></script>
    <script src="localdb.js"></script>
    <script>
      
      var localModels;
      
      window.addEventListener('load', async function() {
        
        localModels = await LocalDb.listModels();

        try {
          const arrangeClient = await ArrangeClient().connect('wss://arrange.avorium.de:42001');
          const modelsFromServer = await arrangeClient.search('voxelhoxel', 'models', {}, '_id');
          // Save models in local database
          for (var i = 0; i < modelsFromServer.length; i++) {
            const model = modelsFromServer[i];
            const localModelIndex = localModels.findIndex(function(m) { return m._id === model._id });
            if (localModelIndex < 0) {
              const modelFromServer = await arrangeClient.read('voxelhoxel', 'models', model._id);
              LocalDb.saveModel(modelFromServer);
              localModels.push(modelFromServer);
            } else if (Object.keys(localModels[localModelIndex].painted).length < 1) {
              const modelFromServer = await arrangeClient.read('voxelhoxel', 'models', model._id);
              LocalDb.saveModel(modelFromServer);
              localModels[localModelIndex] = modelFromServer;
            }
          }
        } catch(ex) {
          console.log('We are offline.');
        }
        
        const list = document.querySelector('.list');
        localModels.sort(function(a, b) { 
          if (a.complete && !b.complete) return 1;
          if (!a.complete && b.complete) return -1;
          return 0;
        });
        localModels.forEach(function(model) {
          const el = document.createElement('div');
          if (Object.keys(model.painted).length < 1) {
            el.innerHTML = '<img src="' + model.thumbnail + '" style="filter:grayscale(100%);"/><span class="new">Neu</span>';
          } else {
            el.innerHTML = '<img src="' + model.thumbnail + '"/>' + (model.complete ? '<span class="complete">&#10004;</span>' : '');
          }
          el.addEventListener('click', function() {
            location.href = 'play.html?_id=' + model._id;
          });
          list.appendChild(el);
        });
        
      });
    </script>
  </head>
  <body>
    <div class="list"></div>
  </body>
</html>
